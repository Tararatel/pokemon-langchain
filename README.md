# Система получения информации о покемонах

Этот проект представляет собой приложение на Node.js, которое собирает и обрабатывает информацию о покемонах, используя локальную базу данных, внешние API и инструменты веб-поиска. Приложение включает современный веб-интерфейс с улучшенным UI/UX для удобного взаимодействия с пользователем. Оно использует агент на основе LangChain для нормализации имен покемонов и получения данных из нескольких источников в приоритетном порядке.

## Возможности
- **Нормализация имен**: Исправляет опечатки и транслитерирует имена покемонов (например, "пикачу" → "pikachu", "чучу" → "pichu") с помощью локальной модели LLaMA.
- **Получение данных из нескольких источников**:
  1. Запрашивает информацию о покемоне в локальной базе данных PostgreSQL.
  2. Если данные не найдены, обращается к [PokeAPI](https://pokeapi.co/).
  3. В случае неудачи использует [Tavily Search API](https://tavily.com/) для веб-поиска с фильтрацией результатов по имени.
  4. Возвращает сообщение по умолчанию, если информация не найдена.
- **Веб-интерфейс**:
  - Современный дизайн с анимациями, градиентами и фоновым изображением покемонов.
  - Адаптивная верстка для мобильных и десктопных устройств.
  - История последних запросов (до 6 записей) с возможностью повторного поиска.
  - Интерактивные элементы: кнопка очистки поля, индикатор загрузки, поддержка клавиши Enter.
  - Улучшенная доступность с ARIA-атрибутами и семантической разметкой.
- **API-эндпоинт**: Сервер предоставляет эндпоинт `/api/pokemon` для обработки запросов.
- **Граф на основе StateGraph**: Использует `StateGraph` от LangChain для управления процессом нормализации и получения данных.
- **Обработка ошибок**: Надежная обработка ошибок для сбоев API и некорректных входных данных.
- **Конфигурация окружения**: Использует `dotenv` для безопасного управления ключами API.

## Требования
- **Node.js**: Версия 18 или выше.
- **PostgreSQL**: Работающая база данных PostgreSQL для хранения информации о покемонах.
- **Ollama**: Локальная установка [Ollama](https://ollama.ai/) с моделью `llama3.1:8b` для нормализации имен.
- **Ключи API**:
  - Ключ [GigaChat API](https://gigachat.ai/).
  - Ключ [Tavily API](https://tavily.com/).
  - (Опционально) Ключ [LangSmith API](https://smith.langchain.com/) для трассировки.

## Установка
1. **Клонируйте репозиторий**:
   ```bash
   git clone https://github.com/your-username/pokemon-info-system.git
   cd pokemon-info-system
   ```

2. **Установите зависимости**:
   ```bash
   npm install
   ```

3. **Настройте файл окружения**:
   Создайте файл `.env` в корне проекта и добавьте следующие переменные:
   ```
   GIGACHAT_KEY=ваш_действительный_ключ_gigachat
   TAVILY_API_KEY=ваш_действительный_ключ_tavily
   LANGSMITH_API_KEY=ваш_действительный_ключ_langsmith
   LANGSMITH_TRACING=false
   LANGSMITH_ENDPOINT=https://api.smith.langchain.com
   LANGSMITH_PROJECT=PokemonGraph
   PORT=3000
   ```
   - Если LangSmith используется, установите `LANGSMITH_TRACING=true` и проверьте ключ.
   - Убедитесь, что `GIGACHAT_KEY` и `TAVILY_API_KEY` действительны.

4. **Настройте базу данных**:
   - Убедитесь, что PostgreSQL установлен и работает.
   - Настройте подключение к базе данных в файле `src/db/models/index.js`.
   - Выполните миграции для создания таблицы покемонов:
     ```bash
     npx sequelize-cli db:migrate
     ```

5. **Запустите Ollama**:
   - Установите [Ollama](https://ollama.ai/) и запустите модель `llama3.1:8b`:
     ```bash
     ollama run llama3.1:8b
     ```

6. **Проверьте ключи API**:
   - Проверьте `GIGACHAT_KEY` в личном кабинете [GigaChat](https://gigachat.ai/).
   - Проверьте `TAVILY_API_KEY` в личном кабинете [Tavily](https://tavily.com/).
   - (Опционально) Проверьте `LANGSMITH_API_KEY` в [LangSmith](https://smith.langchain.com/).

## Использование
### Через веб-интерфейс
1. **Запустите сервер**:
   ```bash
   npm run dev
   ```
2. **Откройте интерфейс**:
   - Перейдите в браузере по адресу `http://localhost:3000`.
   - Введите имя покемона (например, "Пикачу", "чучу") в поле ввода.
   - Нажмите "Найти" или клавишу Enter для получения информации.
   - Результат отобразится в правом окне, а запрос сохранится в истории ниже.
   - Кликните на запись в истории для повторного поиска.

### Через API
- Отправьте POST-запрос к эндпоинту `/api/pokemon`:
  ```bash
  curl -X POST http://localhost:3000/api/pokemon -H "Content-Type: application/json" -d '{"name":"Pikachu"}'
  ```
- Ожидаемый ответ:
  ```json
  {
    "result": "Покемон pikachu: тип - electric, рост - 40 см, вес - 6 кг, источник: PokeAPI"
  }
  ```

### Пример вывода
```
Покемон pikachu: тип - electric, рост - 40 см, вес - 6 кг, источник: PokeAPI
Покемон pichu: тип - electric, рост - 30 см, вес - 2 кг, источник: PokeAPI
Покемон chuchu: Информация не найдена, источник: Tavily
```

## Структура проекта
- `src/server.js`: Точка входа сервера, обслуживает статические файлы и API-эндпоинт `/api/pokemon`.
- `src/agent/index.js`: Определяет граф LangChain для нормализации имен и получения данных.
- `src/tools/`:
  - `pokemonDbTool.js`: Инструмент для поиска в локальной базе данных.
  - `pokemonPokeApiTool.js`: Инструмент для запросов к PokeAPI.
  - `pokemonTavilyTool.js`: Инструмент для веб-поиска через Tavily с фильтрацией результатов.
  - `fallbackTool.js`: Инструмент для обработки случаев, когда данные не найдены.
- `src/db/models/index.js`: Конфигурация и модели Sequelize для работы с PostgreSQL.
- `static/index.html`: Статическая HTML-страница с современным веб-интерфейсом.

## Алгоритм работы
1. **Нормализация имени**: Локальная модель `llama3.1:8b` исправляет опечатки и транслитерирует имена (например, "чучу" → "pichu").
2. **Поиск данных**:
   - Проверяет локальную базу данных с помощью `pokemonDbTool`.
   - Если данные не найдены, обращается к `pokemonPokeApiTool` (PokeAPI).
   - Если API не возвращает данные, использует `pokemonTavilyTool` (Tavily Search) с фильтрацией по имени.
   - Если ничего не найдено, возвращает сообщение через `fallbackTool`.
3. **Формат ответа**: `Покемон [имя]: [информация], источник: [источник]`.

## Устранение неполадок
- **Предупреждения LangSmith о циклическом JSON**:
  - Установите `LANGSMITH_TRACING=false` в `.env`, если трассировка не нужна.
  - Если LangSmith используется, проверьте передаваемые объекты на циклические ссылки:
    ```javascript
    console.log('Сериализация состояния:', JSON.stringify({ messages: [], normalizedName: '' }, null, 2));
    ```
- **Ошибка 401 Unauthorized (GigaChat)**:
  - Проверьте, что `GIGACHAT_KEY` в `.env` действителен и имеет доступ к модели `GigaChat-2`.
  - Тестируйте ключ:
    ```bash
    curl -X POST https://gigachat.devices.sberbank.ru/api/v1/chat/completions -H "Authorization: Bearer ваш_ключ_gigachat" -H "Content-Type: application/json" -d '{"model":"GigaChat-2","messages":[{"role":"user","content":"Тест"}]}'
    ```
- **Некорректная нормализация имени**:
  - Проверьте промпт в `normalizePokemonName` и протестируйте с разными именами:
    ```bash
    curl -X POST http://localhost:3000/api/pokemon -d '{"name":"чучу"}'
    ```
  - Убедитесь, что модель `llama3.1:8b` корректно транслитерирует (например, "чучу" → "pichu").
- **Некорректные результаты Tavily**:
  - Проверьте логи в `pokemonTavilyTool.js`:
    ```javascript
    console.log('Ответ Tavily:', JSON.stringify(response.results, null, 2));
    ```
  - Убедитесь, что `TAVILY_API_KEY` действителен.
- **Ollama не работает**:
  - Убедитесь, что Ollama запущена и модель `llama3.1:8b` доступна:
    ```bash
    curl http://localhost:11434/api/tags
    ```
- **Проблемы с базой данных**:
  - Убедитесь, что PostgreSQL работает и конфигурация в `src/db/models/index.js` корректна.
  - Выполните миграции:
    ```bash
    npx sequelize-cli db:migrate
    ```

## Конфигурация инструментов
- **pokemonDbTool**: Ищет в локальной базе данных PostgreSQL. Требуется таблица `Pokemons` с полями `name`, `type`, `height`, `weight`.
- **pokemonPokeApiTool**: Запрашивает данные через PokeAPI. Рост конвертируется из дециметров в сантиметры, вес — из гектограмм в килограммы.
- **pokemonTavilyTool**: Выполняет веб-поиск через Tavily, фильтруя результаты по имени покемона.
- **fallbackTool**: Возвращает сообщение об отсутствии информации.
